version: '3.8'

services:
  op-geth:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:latest
    container_name: base-op-geth
    restart: unless-stopped
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
      - "30303:30303/udp"
    volumes:
      - geth-data:/data
      - ./jwt.hex:/config/jwt.hex:ro
    command:
      - --datadir=/data
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.vhosts=*
      - --http.corsdomain=*
      - --http.api=eth,net,web3,debug,txpool
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.origins=*
      - --ws.api=eth,net,web3
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/config/jwt.hex
      - --syncmode=snap
      - --gcmode=full
      - --rollup.sequencerhttp=https://mainnet-sequencer.base.org
      - --rollup.disabletxpoolgossip=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  op-node:
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:latest
    container_name: base-op-node
    restart: unless-stopped
    depends_on:
      - op-geth
    ports:
      - "9545:9545"
      - "9222:9222"
      - "9222:9222/udp"
      - "7300:7300"
    volumes:
      - ./jwt.hex:/config/jwt.hex:ro
      - ./rollup.json:/config/rollup.json:ro
    environment:
      - OP_NODE_L1_ETH_RPC=${L1_RPC_URL}
      - OP_NODE_L1_BEACON=${L1_BEACON_URL}
    command:
      - --network=base-mainnet
      - --l1=${OP_NODE_L1_ETH_RPC}
      - --l1.beacon=${OP_NODE_L1_BEACON}
      - --l2=http://op-geth:8551
      - --l2.jwt-secret=/config/jwt.hex
      - --rpc.addr=0.0.0.0
      - --rpc.port=9545
      - --p2p.listen.ip=0.0.0.0
      - --p2p.listen.tcp=9222
      - --p2p.listen.udp=9222
      - --metrics.enabled
      - --metrics.addr=0.0.0.0
      - --metrics.port=7300
      - --syncmode=execution-layer
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

volumes:
  geth-data:

networks:
  default:
    name: base-network
